// åŒ…åå£°æ˜ï¼šå®šä¹‰è¿™ä¸ªç±»æ‰€å±çš„åŒ…
// åŒ…åå¿…é¡»ä¸ AndroidManifest.xml ä¸­å£°æ˜çš„åŒ…åä¸€è‡´
package com.example.demo2;

// å¯¼å…¥ Android SDK çš„ç±»
import android.os.Bundle;  // Bundle ç”¨äºä¿å­˜å’Œæ¢å¤ Activity çŠ¶æ€
import android.util.Log;  // æ—¥å¿—å·¥å…·ç±»
import android.widget.Toast;  // Toast æç¤º

// å¯¼å…¥ AndroidX åº“çš„ç±»
import androidx.activity.EdgeToEdge;  // è¾¹åˆ°è¾¹æ˜¾ç¤ºåŠŸèƒ½ï¼ˆå…¨å±æ˜¾ç¤ºï¼‰
import androidx.annotation.NonNull;  // NonNull æ³¨è§£
import androidx.appcompat.app.AppCompatActivity;  // å‘åå…¼å®¹çš„ Activity åŸºç±»
import androidx.core.graphics.Insets;  // è¡¨ç¤ºå±å¹•è¾¹ç¼˜çš„æ’å…¥åŒºåŸŸ
import androidx.core.view.ViewCompat;  // è§†å›¾å…¼å®¹æ€§å·¥å…·ç±»
import androidx.core.view.WindowInsetsCompat;  // çª—å£æ’å…¥åŒºåŸŸå…¼å®¹ç±»
import androidx.recyclerview.widget.LinearLayoutManager;  // çº¿æ€§å¸ƒå±€ç®¡ç†å™¨
import androidx.recyclerview.widget.GridLayoutManager;  // ç½‘æ ¼å¸ƒå±€ç®¡ç†å™¨
import androidx.recyclerview.widget.RecyclerView;  // RecyclerView ç»„ä»¶

// å¯¼å…¥ Handler ç”¨äºå®šæ—¶ä»»åŠ¡
import android.os.Handler;
import android.os.Looper;

// ã€ç¬¬8æ¬¡ä¿®æ”¹ã€‘å¯¼å…¥åˆ†ç±»æ ‡ç­¾å’Œæ»šåŠ¨æ¡ç›¸å…³ç±»
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewGroup;
import android.widget.LinearLayout;
import android.widget.TextView;
import android.widget.Button;
import android.widget.ImageButton;
import android.graphics.Color;

// å¯¼å…¥ Java å·¥å…·ç±»
import java.util.ArrayList;  // åŠ¨æ€æ•°ç»„åˆ—è¡¨
import java.util.List;  // åˆ—è¡¨æ¥å£

// å¯¼å…¥ç½‘ç»œè¯·æ±‚ç›¸å…³ç±»
import com.example.demo2.api.RetrofitClient;
import com.example.demo2.api.NewsApiService;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

// ã€ç¬¬6æ¬¡ä¿®æ”¹ã€‘å¯¼å…¥ Room æ•°æ®åº“ç›¸å…³ç±»
import com.example.demo2.database.AppDatabase;
import com.example.demo2.database.CachedNews;
import com.example.demo2.repository.NewsRepository;

/**
 * MainActivity - åº”ç”¨çš„ä¸»ç•Œé¢ Activity
 * 
 * Activity æ˜¯ Android çš„å››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œä»£è¡¨ä¸€ä¸ªå±å¹•ç•Œé¢
 * è¿™æ˜¯åº”ç”¨å¯åŠ¨æ—¶ç¬¬ä¸€ä¸ªæ˜¾ç¤ºçš„ç•Œé¢
 * 
 * ç»§æ‰¿å…³ç³»ï¼š
 * MainActivity -> AppCompatActivity -> Activity
 * 
 * AppCompatActivity æä¾›äº†å‘åå…¼å®¹çš„åŠŸèƒ½ï¼Œè®©æ–°ç‰ˆæœ¬çš„ç‰¹æ€§å¯ä»¥åœ¨æ—§è®¾å¤‡ä¸Šè¿è¡Œ
 */
public class MainActivity extends AppCompatActivity {
    
    // æ—¥å¿—æ ‡ç­¾
    private static final String TAG = "MainActivity";

    // RecyclerView ç»„ä»¶ï¼šç”¨äºæ˜¾ç¤ºæ–°é—»åˆ—è¡¨
    private RecyclerView recyclerView;
    
    // é€‚é…å™¨ï¼šè¿æ¥æ•°æ®å’Œ RecyclerView
    private NewsAdapter newsAdapter;
    
    // æ–°é—»æ•°æ®åˆ—è¡¨
    private List<NewsItem> newsList;
    
    // API æœåŠ¡
    private NewsApiService apiService;
    
    // ã€ç¬¬6æ¬¡ä¿®æ”¹ã€‘Room æ•°æ®åº“å’Œæ•°æ®ä»“åº“
    private AppDatabase database;
    private NewsRepository newsRepository;
    
    // æ˜¯å¦æ­£åœ¨åˆ·æ–°
    private boolean isRefreshing = false;
    
    // ã€ç¬¬10æ¬¡ä¿®æ”¹ã€‘ä¸‹æ‹‰åˆ·æ–°ç›¸å…³å˜é‡
    private float pullDownStartY = 0;  // ä¸‹æ‹‰å¼€å§‹çš„Yåæ ‡
    private boolean isPullingDown = false;  // æ˜¯å¦æ­£åœ¨ä¸‹æ‹‰
    private static final int PULL_THRESHOLD = 200;  // ä¸‹æ‹‰é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
    
    // ã€ç¬¬8æ¬¡ä¿®æ”¹ã€‘åˆ†ç±»ç›¸å…³å˜é‡
    private LinearLayout categoryContainer;
    private String currentCategory = null;  // å½“å‰é€‰ä¸­çš„åˆ†ç±»ï¼ˆnullè¡¨ç¤ºå…¨éƒ¨ï¼‰
    private List<TextView> categoryTabs = new ArrayList<>();  // åˆ†ç±»æ ‡ç­¾åˆ—è¡¨
    
    // ã€ç¬¬8æ¬¡ä¿®æ”¹ã€‘è‡ªå®šä¹‰æ»šåŠ¨æ¡ç›¸å…³å˜é‡
    private View customScrollbar;
    private boolean isDraggingScrollbar = false;
    private float scrollbarDragStartY = 0;
    private int scrollbarInitialTop = 0;
    
    // ã€ç¬¬13æ¬¡ä¿®æ”¹ã€‘åˆ†é¡µåŠ è½½ç›¸å…³å˜é‡
    private int currentOffset = 0;  // å½“å‰åç§»é‡
    private static final int PAGE_SIZE = 2;  // æ¯é¡µæ•°é‡ï¼ˆæ”¹ä¸º2æ¡ä»¥ä¾¿æµ‹è¯•ï¼‰
    private boolean isLoadingMore = false;  // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤š
    private boolean hasMoreData = true;  // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    
    // è‡ªåŠ¨åŠ è½½ç›¸å…³å˜é‡
    private Handler autoLoadHandler = new Handler(Looper.getMainLooper());
    private Runnable autoLoadRunnable = null;
    private boolean isAutoLoadTriggered = false;  // é˜²æ­¢é‡å¤è§¦å‘
    private static final int AUTO_LOAD_DELAY = 2000;  // åŠ è½½åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆ2ç§’ï¼‰
    
    // ã€ç¬¬14æ¬¡ä¿®æ”¹ã€‘ä¸ºæ¯ä¸ªåˆ†ç±»å•ç‹¬ç»´æŠ¤çŠ¶æ€
    private java.util.Map<String, Integer> categoryOffsetMap = new java.util.HashMap<>();  // æ¯ä¸ªåˆ†ç±»çš„offset
    private java.util.Map<String, Boolean> categoryHasMoreMap = new java.util.HashMap<>();  // æ¯ä¸ªåˆ†ç±»æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
    private java.util.Map<String, List<NewsItem>> categoryDataMap = new java.util.HashMap<>();  // æ¯ä¸ªåˆ†ç±»çš„æ•°æ®åˆ—è¡¨
    
    // ã€ç¬¬15æ¬¡ä¿®æ”¹ã€‘å…·ä½“åˆ†ç±»åˆ—è¡¨ï¼ˆç”¨äº"å…¨éƒ¨"æ¿å—æ±‡æ€»ï¼‰
    private static final String[] CATEGORY_CODES = {"tech", "economy", "sports", "health", "entertainment", "education", "environment", "food"};
    
    // ã€ç¬¬16æ¬¡ä¿®æ”¹ã€‘å¸ƒå±€æ¨¡å¼åˆ‡æ¢
    private static final int LAYOUT_MODE_SINGLE = 1;  // å•åˆ—æ¨¡å¼
    private static final int LAYOUT_MODE_GRID = 2;    // åŒåˆ—æ¨¡å¼
    private int currentLayoutMode = LAYOUT_MODE_SINGLE;  // é»˜è®¤å•åˆ—
    private ImageButton layoutSwitchButton;
    
    // ã€ç¬¬17æ¬¡ä¿®æ”¹ã€‘å¡ç‰‡æ›å…‰è¿½è¸ª
    private ExposureTracker exposureTracker;
    
    // ã€ç¬¬19æ¬¡ä¿®æ”¹ã€‘æ›å…‰äº‹ä»¶æµ‹è¯•é¢æ¿
    private ExposureTestPanel testPanel;

    /**
     * onCreate() - Activity çš„åˆ›å»ºæ–¹æ³•
     * 
     * è¿™æ˜¯ Activity ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨ Activity åˆ›å»ºæ—¶è°ƒç”¨
     * 
     * Activity ç”Ÿå‘½å‘¨æœŸï¼š
     * onCreate() -> onStart() -> onResume() -> è¿è¡Œä¸­
     * -> onPause() -> onStop() -> onDestroy()
     * 
     * @param savedInstanceState ä¿å­˜çš„å®ä¾‹çŠ¶æ€
     *                          å¦‚æœ Activity è¢«ç³»ç»Ÿé”€æ¯åé‡å»ºï¼Œè¿™é‡Œä¼šåŒ…å«ä¹‹å‰ä¿å­˜çš„æ•°æ®
     *                          é¦–æ¬¡åˆ›å»ºæ—¶ä¸º null
     */
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        Log.d(TAG, "========== MainActivity onCreate å¼€å§‹ ==========");
        
        // è°ƒç”¨çˆ¶ç±»çš„ onCreate æ–¹æ³•ï¼ˆå¿…é¡»è°ƒç”¨ï¼‰
        super.onCreate(savedInstanceState);
        
        // å¯ç”¨è¾¹åˆ°è¾¹æ˜¾ç¤ºï¼ˆEdge-to-Edgeï¼‰
        // è®©å†…å®¹å¯ä»¥å»¶ä¼¸åˆ°çŠ¶æ€æ å’Œå¯¼èˆªæ ä¸‹æ–¹ï¼Œå®ç°æ²‰æµ¸å¼ä½“éªŒ
        EdgeToEdge.enable(this);
        Log.d(TAG, "EdgeToEdge å·²å¯ç”¨");
        
        // è®¾ç½® Activity çš„å¸ƒå±€æ–‡ä»¶
        // R.layout.activity_main å¼•ç”¨ res/layout/activity_main.xml æ–‡ä»¶
        // R æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„èµ„æºç±»ï¼ŒåŒ…å«æ‰€æœ‰èµ„æºçš„ ID
        setContentView(R.layout.activity_main);
        Log.d(TAG, "å¸ƒå±€æ–‡ä»¶å·²è®¾ç½®: activity_main.xml");
        
        // è®¾ç½®çª—å£æ’å…¥ç›‘å¬å™¨ï¼Œå¤„ç†ç³»ç»Ÿæ ï¼ˆçŠ¶æ€æ ã€å¯¼èˆªæ ï¼‰çš„è¾¹è·
        // findViewById(R.id.main) æŸ¥æ‰¾å¸ƒå±€ä¸­ ID ä¸º main çš„è§†å›¾
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -> {
            // è·å–ç³»ç»Ÿæ ï¼ˆçŠ¶æ€æ å’Œå¯¼èˆªæ ï¼‰çš„æ’å…¥åŒºåŸŸ
            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());
            
            // è®¾ç½®è§†å›¾çš„å†…è¾¹è·ï¼Œé¿å…å†…å®¹è¢«ç³»ç»Ÿæ é®æŒ¡
            // left, top, right, bottom åˆ†åˆ«å¯¹åº”å·¦ã€ä¸Šã€å³ã€ä¸‹çš„è¾¹è·
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);
            
            // è¿”å›å¤„ç†åçš„ insets
            return insets;
        });
        Log.d(TAG, "çª—å£æ’å…¥ç›‘å¬å™¨å·²è®¾ç½®");
        
        // ã€ç¬¬8æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–åˆ†ç±»æ ‡ç­¾æ 
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–åˆ†ç±»æ ‡ç­¾æ ...");
        initCategoryTabs();
        
        // ã€ç¬¬16æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–å¸ƒå±€åˆ‡æ¢æŒ‰é’®
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–å¸ƒå±€åˆ‡æ¢æŒ‰é’®...");
        initLayoutSwitchButton();
        
        // åˆå§‹åŒ– RecyclerView
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ– RecyclerView...");
        initRecyclerView();
        
        // ã€ç¬¬8æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–è‡ªå®šä¹‰æ»šåŠ¨æ¡
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–è‡ªå®šä¹‰æ»šåŠ¨æ¡...");
        initCustomScrollbar();
        
        // åˆå§‹åŒ–æ‰‹åŠ¨åˆ·æ–°ç›‘å¬
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–æ‰‹åŠ¨åˆ·æ–°ç›‘å¬...");
        initPullToRefresh();
        
        // ã€ç¬¬11æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–åŠ è½½æ›´å¤šæ–‡æœ¬
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–åŠ è½½æ›´å¤šæ–‡æœ¬...");
        initLoadMoreText();
        
        // åˆå§‹åŒ– API æœåŠ¡
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ– API æœåŠ¡...");
        apiService = RetrofitClient.getNewsApiService();
        Log.d(TAG, "API æœåŠ¡åˆå§‹åŒ–å®Œæˆ");
        
        // ã€ç¬¬6æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–æ•°æ®åº“å’Œæ•°æ®ä»“åº“
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–æ•°æ®åº“...");
        database = AppDatabase.getInstance(this);
        newsRepository = new NewsRepository(this, database.newsDao(), apiService);
        Log.d(TAG, "æ•°æ®åº“å’Œæ•°æ®ä»“åº“åˆå§‹åŒ–å®Œæˆ");
        
        // ã€ç¬¬15æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŠ è½½ï¼šä¸ºæ‰€æœ‰åˆ†ç±»åŠ è½½ç¬¬ä¸€é¡µæ•°æ®
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–æ‰€æœ‰åˆ†ç±»æ•°æ®...");
        loadInitialDataForAllCategories();
        
        // ã€ç¬¬17æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–å¡ç‰‡æ›å…‰è¿½è¸ª
        Log.d(TAG, "å‡†å¤‡åˆå§‹åŒ–å¡ç‰‡æ›å…‰è¿½è¸ª...");
        initExposureTracker();
        
        Log.d(TAG, "========== MainActivity onCreate å®Œæˆ ==========");
    }
    
    /**
     * initRecyclerView - åˆå§‹åŒ– RecyclerView
     * 
     * è®¾ç½® RecyclerView çš„å¸ƒå±€ç®¡ç†å™¨å’Œé€‚é…å™¨
     */
    private void initRecyclerView() {
        Log.d(TAG, "---------- initRecyclerView å¼€å§‹ ----------");
        
        // 1. è·å– RecyclerView ç»„ä»¶
        recyclerView = findViewById(R.id.recyclerView);
        if (recyclerView == null) {
            Log.e(TAG, "âŒ RecyclerView ä¸º nullï¼æ£€æŸ¥å¸ƒå±€æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ id=recyclerView");
            return;
        }
        Log.d(TAG, "âœ… RecyclerView è·å–æˆåŠŸ");
        
        // 2. åˆ›å»ºçº¿æ€§å¸ƒå±€ç®¡ç†å™¨
        // LinearLayoutManagerï¼šå‚ç›´çº¿æ€§å¸ƒå±€ï¼Œä»ä¸Šåˆ°ä¸‹æ’åˆ—
        // å…¶ä»–é€‰é¡¹ï¼šGridLayoutManagerï¼ˆç½‘æ ¼å¸ƒå±€ï¼‰ã€StaggeredGridLayoutManagerï¼ˆç€‘å¸ƒæµï¼‰
        LinearLayoutManager layoutManager = new LinearLayoutManager(this);
        recyclerView.setLayoutManager(layoutManager);
        Log.d(TAG, "âœ… LayoutManager è®¾ç½®å®Œæˆ");
        
        // 3. åˆå§‹åŒ–æ•°æ®åˆ—è¡¨
        newsList = new ArrayList<>();
        Log.d(TAG, "âœ… æ•°æ®åˆ—è¡¨åˆå§‹åŒ–å®Œæˆï¼Œå½“å‰å¤§å°: " + newsList.size());
        
        // 4. åˆ›å»ºé€‚é…å™¨
        newsAdapter = new NewsAdapter(newsList);
        Log.d(TAG, "âœ… NewsAdapter åˆ›å»ºå®Œæˆ");
        
        // ã€ç¬¬12æ¬¡ä¿®æ”¹ã€‘è®¾ç½®åŠ è½½æ›´å¤šç›‘å¬å™¨
        newsAdapter.setOnLoadMoreClickListener(() -> {
            Log.d(TAG, "ğŸ”˜ ç”¨æˆ·ç‚¹å‡»åŠ è½½æ›´å¤šå¡ç‰‡");
            loadMoreNews();
        });
        
        // ã€ç¬¬12æ¬¡ä¿®æ”¹ã€‘è®¾ç½®åˆ é™¤ç›‘å¬å™¨
        newsAdapter.setOnItemDeleteListener(position -> {
            Log.d(TAG, "ğŸ—‘ï¸ åˆ é™¤ä½ç½®: " + position);
            if (position >= 0 && position < newsList.size()) {
                NewsItem deletedItem = newsList.get(position);
                newsList.remove(position);
                newsAdapter.notifyItemRemoved(position);
                Toast.makeText(this, "å·²åˆ é™¤ï¼š" + deletedItem.getTitle(), Toast.LENGTH_SHORT).show();
            }
        });
        
        // 5. è®¾ç½®é€‚é…å™¨åˆ° RecyclerView
        recyclerView.setAdapter(newsAdapter);
        Log.d(TAG, "âœ… Adapter è®¾ç½®åˆ° RecyclerView");
        
        // å¯é€‰ï¼šè®¾ç½®å›ºå®šå¤§å°ä¼˜åŒ–æ€§èƒ½
        // å¦‚æœ RecyclerView çš„å¤§å°ä¸ä¼šå› ä¸ºå†…å®¹æ”¹å˜è€Œæ”¹å˜ï¼Œè®¾ç½®ä¸º true å¯ä»¥æé«˜æ€§èƒ½
        recyclerView.setHasFixedSize(true);
        Log.d(TAG, "âœ… RecyclerView å›ºå®šå¤§å°å·²è®¾ç½®");
        
        Log.d(TAG, "---------- initRecyclerView å®Œæˆ ----------");
    }
    
    /**
     * ã€ç¬¬6æ¬¡ä¿®æ”¹ã€‘æ–°æ–¹æ³•ï¼šå…ˆåŠ è½½ç¼“å­˜ï¼Œå†è¯·æ±‚ç½‘ç»œ
     * 
     * æ•°æ®åŠ è½½ç­–ç•¥ï¼š
     * 1. å…ˆä»æœ¬åœ°ç¼“å­˜è¯»å–æ•°æ®ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
     * 2. åŒæ—¶å‘èµ·ç½‘ç»œè¯·æ±‚ï¼ˆè·å–æœ€æ–°æ•°æ®ï¼‰
     * 3. ç½‘ç»œè¯·æ±‚æˆåŠŸåæ›´æ–°ç¼“å­˜å’Œ UI
     * 4. ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶æç¤ºç”¨æˆ·æ­£åœ¨ä½¿ç”¨ç¼“å­˜æ•°æ®
     * 
     * ä¼˜åŠ¿ï¼š
     * - ç§’å¼€ä½“éªŒï¼šç«‹å³æ˜¾ç¤ºç¼“å­˜æ•°æ®
     * - ç¦»çº¿å¯ç”¨ï¼šæ— ç½‘ç»œæ—¶ä¹Ÿèƒ½çœ‹åˆ°ç¼“å­˜çš„æ–°é—»
     * - è‡ªåŠ¨æ›´æ–°ï¼šåå°è·å–æœ€æ–°æ•°æ®
     */
    private void loadNewsWithCache() {
        Log.d(TAG, "========== å¼€å§‹åŠ è½½æ•°æ®ï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰==========");
        
        // 1. å…ˆä»æœ¬åœ°ç¼“å­˜åŠ è½½ï¼ˆåœ¨å­çº¿ç¨‹ï¼‰
        final String categoryToLoad = currentCategory;  // ä¿å­˜å½“å‰åˆ†ç±»
        new Thread(() -> {
            Log.d(TAG, "ğŸ“– æ­¥éª¤1ï¼šä»æœ¬åœ°ç¼“å­˜è¯»å–æ•°æ®ï¼Œåˆ†ç±»=" + categoryToLoad);
            List<CachedNews> cachedNewsList = newsRepository.getCachedNewsByCategory(categoryToLoad, 10);
            
            if (!cachedNewsList.isEmpty()) {
                Log.d(TAG, "âœ… ç¼“å­˜è¯»å–æˆåŠŸï¼Œå…± " + cachedNewsList.size() + " æ¡");
                
                // è½¬æ¢ä¸º NewsItem æ ¼å¼
                List<NewsItem> cachedNewsItems = NewsRepository.convertToNewsItems(cachedNewsList);
                
                // åœ¨ä¸»çº¿ç¨‹æ›´æ–° UI
                runOnUiThread(() -> {
                    Log.d(TAG, "ğŸ¨ æ›´æ–° UIï¼ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼‰");
                    newsList.clear();
                    newsList.addAll(cachedNewsItems);
                    newsAdapter.notifyDataSetChanged();
                    String msg = categoryToLoad == null ? 
                        "ğŸ“– æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆå…¨éƒ¨ï¼‰" : 
                        "ğŸ“– æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆ" + categoryToLoad + "ï¼‰";
                    Toast.makeText(MainActivity.this, 
                        msg + " - " + cachedNewsItems.size() + " æ¡", 
                        Toast.LENGTH_SHORT).show();
                });
            } else {
                Log.d(TAG, "â„¹ï¸ ç¼“å­˜ä¸ºç©ºï¼Œç­‰å¾…ç½‘ç»œæ•°æ®...");
            }
        }).start();
        
        // 2. åŒæ—¶ä»æœåŠ¡å™¨åŠ è½½æœ€æ–°æ•°æ®
        Log.d(TAG, "ğŸŒ æ­¥éª¤2ï¼šä»æœåŠ¡å™¨åŠ è½½æœ€æ–°æ•°æ®...");
        loadNewsFromServer();
    }
    
    /**
     * loadNewsFromServer - ä»æœåŠ¡å™¨åŠ è½½æ–°é—»æ•°æ®
     * 
     * ã€ç¬¬9æ¬¡ä¿®æ”¹ã€‘ä¿®æ”¹ä¸ºåˆ†é¡µåŠ è½½ï¼š
     * - åˆå§‹åŠ è½½ï¼šoffset=0, limit=10
     * - åŠ è½½æ›´å¤šï¼šoffseté€’å¢, limit=10
     * - æˆåŠŸåè‡ªåŠ¨ä¿å­˜åˆ°ç¼“å­˜
     * 
     * ä½¿ç”¨ Retrofit è¿›è¡Œå¼‚æ­¥ç½‘ç»œè¯·æ±‚
     */
    private void loadNewsFromServer() {
        loadNewsFromServer(false);  // é»˜è®¤ä¸æ˜¯åŠ è½½æ›´å¤š
    }
    
    /**
     * ã€ç¬¬9æ¬¡ä¿®æ”¹ã€‘ä»æœåŠ¡å™¨åŠ è½½æ–°é—»æ•°æ®ï¼ˆæ”¯æŒåŠ è½½æ›´å¤šï¼‰
     * 
     * @param isLoadMore trueè¡¨ç¤ºåŠ è½½æ›´å¤šï¼Œfalseè¡¨ç¤ºåˆ·æ–°
     */
    private void loadNewsFromServer(boolean isLoadMore) {
        isLoadingMore = isLoadMore;
        
        Log.d(TAG, "\n==========================================");
        Log.d(TAG, "ğŸ“¡ å¼€å§‹ç½‘ç»œè¯·æ±‚");
        Log.d(TAG, "==========================================");
        Log.d(TAG, "ğŸ“ è¯·æ±‚å‚æ•°ï¼š");
        Log.d(TAG, "  - åŠ è½½æ¨¡å¼: " + (isLoadMore ? "åŠ è½½æ›´å¤š" : "åˆ·æ–°"));
        Log.d(TAG, "  - å½“å‰åˆ†ç±»: " + (currentCategory == null ? "å…¨éƒ¨" : currentCategory));
        Log.d(TAG, "  - å½“å‰offset: " + currentOffset);
        Log.d(TAG, "  - è¯·æ±‚æ•°é‡(limit): " + PAGE_SIZE);
        Log.d(TAG, "  - isLoadingMoreæ ‡å¿—: " + isLoadingMore);
        Log.d(TAG, "  - hasMoreDataæ ‡å¿—: " + hasMoreData);
        
        // æ ¹æ®å½“å‰åˆ†ç±»æ„é€ è¯·æ±‚
        Call<List<NewsItem>> call;
        if (currentCategory == null) {
            // å…¨éƒ¨åˆ†ç±»
            call = apiService.getNewsList(currentOffset, PAGE_SIZE);
            Log.d(TAG, "è¯·æ±‚å…¨éƒ¨åˆ†ç±»çš„æ–°é—»ï¼Œoffset=" + currentOffset + ", limit=" + PAGE_SIZE);
        } else {
            // æŒ‡å®šåˆ†ç±»
            call = apiService.getNewsListByCategory(currentCategory, currentOffset, PAGE_SIZE);
            Log.d(TAG, "è¯·æ±‚åˆ†ç±»: " + currentCategory + ", offset=" + currentOffset + ", limit=" + PAGE_SIZE);
        }
        Log.d(TAG, "Retrofit Call å¯¹è±¡å·²åˆ›å»º: " + call.request().url());
        
        call.enqueue(new Callback<List<NewsItem>>() {
            @Override
            public void onResponse(Call<List<NewsItem>> call, Response<List<NewsItem>> response) {
                Log.d(TAG, "========== æ”¶åˆ°æœåŠ¡å™¨å“åº” ==========");
                Log.d(TAG, "å“åº”ç : " + response.code());
                Log.d(TAG, "å“åº”æ¶ˆæ¯: " + response.message());
                Log.d(TAG, "æ˜¯å¦æˆåŠŸ: " + response.isSuccessful());
                
                // è¯·æ±‚æˆåŠŸ
                if (response.isSuccessful() && response.body() != null) {
                    List<NewsItem> newsItems = response.body();
                    Log.d(TAG, "âœ… åŠ è½½æˆåŠŸï¼è·å–åˆ° " + newsItems.size() + " æ¡æ–°é—»");
                    
                    // æ‰“å°æ¯æ¡æ–°é—»çš„æ ‡é¢˜ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                    for (int i = 0; i < newsItems.size(); i++) {
                        Log.d(TAG, "æ–°é—» " + (i+1) + ": " + newsItems.get(i).getTitle());
                    }
                    
                    // ã€ç¬¬9æ¬¡ä¿®æ”¹ã€‘æ ¹æ®åŠ è½½æ¨¡å¼æ›´æ–°æ•°æ®
                    Log.d(TAG, "å¼€å§‹æ›´æ–°RecyclerViewæ•°æ®...");
                    if (isLoadMore) {
                        // åŠ è½½æ›´å¤šï¼šè¿½åŠ æ•°æ®
                        int oldSize = newsList.size();
                        newsList.addAll(newsItems);
                        newsAdapter.notifyItemRangeInserted(oldSize, newsItems.size());
                        Log.d(TAG, "è¿½åŠ  " + newsItems.size() + " æ¡æ–°é—»ï¼Œæ€»æ•°: " + newsList.size());
                    } else {
                        // åˆ·æ–°ï¼šæ›¿æ¢æ•°æ®
                        newsList.clear();
                        newsList.addAll(newsItems);
                        newsAdapter.notifyDataSetChanged();
                        Log.d(TAG, "æ›¿æ¢æ•°æ®ï¼Œæ€»æ•°: " + newsList.size());
                    }
                    
                    // ã€ç¬¬13æ¬¡ä¿®æ”¹ã€‘æ›´æ–°åˆ†é¡µçŠ¶æ€å’ŒåŠ è½½æ›´å¤šå¡ç‰‡æ˜¾ç¤º
                    Log.d(TAG, "\n------------------------------------------");
                    Log.d(TAG, "ğŸ“Š åˆ¤æ–­åˆ†é¡µçŠ¶æ€");
                    Log.d(TAG, "------------------------------------------");
                    Log.d(TAG, "ğŸ“ åˆ¤æ–­æ¡ä»¶ï¼š");
                    Log.d(TAG, "  - è¿”å›æ•°æ®é‡: " + newsItems.size());
                    Log.d(TAG, "  - PAGE_SIZE: " + PAGE_SIZE);
                    Log.d(TAG, "  - åˆ¤æ–­ç»“æœ: " + newsItems.size() + " < " + PAGE_SIZE + " = " + (newsItems.size() < PAGE_SIZE));
                    Log.d(TAG, "  - åŠ è½½å‰offset: " + (currentOffset - (isLoadMore ? 0 : currentOffset)));
                    
                    if (newsItems.size() < PAGE_SIZE) {
                        hasMoreData = false;  // æ²¡æœ‰æ›´å¤šæ•°æ®äº†
                        newsAdapter.setHasMoreData(false);  // åŒæ­¥çŠ¶æ€åˆ°Adapter
                        newsAdapter.setShowLoadMore(true);  // ä»ç„¶æ˜¾ç¤ºå¡ç‰‡ï¼Œä½†æ–‡æœ¬å˜ä¸º"å·²åŠ è½½å…¨éƒ¨æ•°æ®"
                        Log.d(TAG, "\nâš ï¸ è¿”å›æ•°æ®ä¸è¶³ï¼Œå·²åŠ è½½å…¨éƒ¨æ•°æ®");
                        Log.d(TAG, "ğŸ“Œ æ›´æ–°çŠ¶æ€ï¼š");
                        Log.d(TAG, "  - hasMoreData: " + hasMoreData);
                        Log.d(TAG, "  - currentOffset: " + currentOffset + " (ä¸å˜)");
                        Log.d(TAG, "  - æ€»æ•°æ®é‡: " + newsList.size());
                        Log.d(TAG, "  - å¡ç‰‡æ˜¾ç¤º: å·²åŠ è½½å…¨éƒ¨æ•°æ®");
                    } else {
                        int oldOffset = currentOffset;
                        currentOffset += newsItems.size();  // æ›´æ–°offset
                        hasMoreData = true;
                        newsAdapter.setHasMoreData(true);  // åŒæ­¥çŠ¶æ€åˆ°Adapter
                        newsAdapter.setShowLoadMore(true);  // æ˜¾ç¤ºåŠ è½½æ›´å¤šå¡ç‰‡
                        Log.d(TAG, "\nâœ… è¿˜æœ‰æ›´å¤šæ•°æ®å¯åŠ è½½");
                        Log.d(TAG, "ğŸ“Œ æ›´æ–°çŠ¶æ€ï¼š");
                        Log.d(TAG, "  - hasMoreData: " + hasMoreData);
                        Log.d(TAG, "  - currentOffset: " + oldOffset + " â†’ " + currentOffset + " (+" + newsItems.size() + ")");
                        Log.d(TAG, "  - æ€»æ•°æ®é‡: " + newsList.size());
                        Log.d(TAG, "  - å¡ç‰‡æ˜¾ç¤º: ç‚¹å‡»åŠ è½½æ›´å¤š");
                    }
                    Log.d(TAG, "------------------------------------------\n");
                    
                    // ã€ç¬¬15æ¬¡ä¿®æ”¹ã€‘æ›´æ–°åˆ†ç±»æ•°æ®Mapï¼ˆç”¨äº"å…¨éƒ¨"æ¿å—æ±‡æ€»ï¼‰
                    if (currentCategory != null) {
                        // å½“å‰æ˜¯å…·ä½“åˆ†ç±»ï¼Œæ›´æ–°è¯¥åˆ†ç±»çš„æ•°æ®
                        categoryDataMap.put(currentCategory, new ArrayList<>(newsList));
                        categoryOffsetMap.put(currentCategory, currentOffset);
                        categoryHasMoreMap.put(currentCategory, hasMoreData);
                        Log.d(TAG, "ğŸ’¾ æ›´æ–°ã€" + currentCategory + "ã€‘æ•°æ®åˆ°Map: " + newsList.size() + " æ¡");
                    }
                    
                    // ã€ç¬¬6æ¬¡ä¿®æ”¹ã€‘ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆåœ¨å­çº¿ç¨‹ï¼‰
                    if (!isLoadMore) {  // åªåœ¨åˆ·æ–°æ—¶ä¿å­˜ç¼“å­˜
                        new Thread(() -> {
                            Log.d(TAG, "ğŸ’¾ ä¿å­˜æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜...");
                            newsRepository.cacheNews(newsItems);
                            Log.d(TAG, "âœ… ç¼“å­˜ä¿å­˜å®Œæˆ");
                        }).start();
                    }
                    
                    String message = isLoadMore ? 
                        "âœ… åŠ è½½æ›´å¤šæˆåŠŸï¼è·å– " + newsItems.size() + " æ¡æ–°é—»" :
                        "âœ… åˆ·æ–°æˆåŠŸï¼è·å– " + newsItems.size() + " æ¡æ–°é—»";
                    Toast.makeText(MainActivity.this, message, Toast.LENGTH_SHORT).show();
                } else {
                    Log.e(TAG, "âŒ è¯·æ±‚å¤±è´¥");
                    Log.e(TAG, "å“åº”ç : " + response.code());
                    Log.e(TAG, "é”™è¯¯ä¿¡æ¯: " + response.message());
                    
                    try {
                        if (response.errorBody() != null) {
                            String errorBody = response.errorBody().string();
                            Log.e(TAG, "é”™è¯¯è¯¦æƒ…: " + errorBody);
                        }
                    } catch (Exception e) {
                        Log.e(TAG, "æ— æ³•è¯»å–é”™è¯¯è¯¦æƒ…", e);
                    }
                    
                    Toast.makeText(MainActivity.this, 
                        "âŒ åŠ è½½å¤±è´¥ï¼š" + response.code(), 
                        Toast.LENGTH_SHORT).show();
                }
            
            // ã€ç¬¬13æ¬¡ä¿®æ”¹ã€‘åˆ·æ–°æˆ–åŠ è½½å®Œæˆï¼Œæ¢å¤åŠ è½½ä¸­çŠ¶æ€
            Log.d(TAG, "\nğŸ”„ æ¢å¤åŠ è½½çŠ¶æ€æ ‡å¿—");
            Log.d(TAG, "  - isRefreshing: " + isRefreshing + " â†’ false");
            Log.d(TAG, "  - isLoadingMore: " + isLoadingMore + " â†’ false");
            isRefreshing = false;
            isLoadingMore = false;
            isAutoLoadTriggered = false;  // é‡ç½®è‡ªåŠ¨åŠ è½½æ ‡å¿—ï¼Œå…è®¸ä¸‹æ¬¡è‡ªåŠ¨åŠ è½½
            newsAdapter.setLoading(false);  // æ¢å¤åŠ è½½ä¸­çŠ¶æ€
            Log.d(TAG, "âœ… æœ¬æ¬¡è¯·æ±‚å®Œæˆ");
            Log.d(TAG, "==========================================\n");
        }

        @Override
        public void onFailure(Call<List<NewsItem>> call, Throwable t) {
            Log.e(TAG, "========== ç½‘ç»œè¯·æ±‚å¤±è´¥ ==========");
            Log.e(TAG, "âŒ é”™è¯¯ç±»å‹: " + t.getClass().getName());
            Log.e(TAG, "âŒ é”™è¯¯æ¶ˆæ¯: " + t.getMessage());
            Log.e(TAG, "âŒ è¯·æ±‚URL: " + call.request().url());
            
            // æ‰“å°å®Œæ•´çš„å †æ ˆè·Ÿè¸ª
            t.printStackTrace();
            
            // æ ¹æ®ä¸åŒçš„é”™è¯¯ç±»å‹ç»™å‡ºæç¤º
            String errorMsg;
            if (t instanceof java.net.UnknownHostException) {
                errorMsg = "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
                Log.e(TAG, "æç¤º: å¯èƒ½æ˜¯DNSè§£æå¤±è´¥æˆ–ç½‘ç»œæœªè¿æ¥");
            } else if (t instanceof java.net.ConnectException) {
                errorMsg = "è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯å·²å¯åŠ¨";
                Log.e(TAG, "æç¤º: åç«¯æœåŠ¡å¯èƒ½æœªå¯åŠ¨ï¼Œæˆ–ç«¯å£è¢«å ç”¨");
            } else if (t instanceof java.net.SocketTimeoutException) {
                errorMsg = "è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
                Log.e(TAG, "æç¤º: ç½‘ç»œé€Ÿåº¦æ…¢æˆ–æœåŠ¡å™¨å“åº”æ…¢");
            } else {
                errorMsg = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š" + t.getMessage();
            }
            
            // ã€ç¬¬6æ¬¡ä¿®æ”¹ã€‘ç½‘ç»œå¤±è´¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®
            if (!newsList.isEmpty()) {
                // å¦‚æœå·²ç»æ˜¾ç¤ºäº†ç¼“å­˜æ•°æ®ï¼Œæç¤ºç”¨æˆ·
                Toast.makeText(MainActivity.this, 
                    "âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæ˜¾ç¤ºç¼“å­˜æ•°æ®", 
                    Toast.LENGTH_LONG).show();
            } else {
                // å¦‚æœæ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                Toast.makeText(MainActivity.this, 
                    errorMsg, 
                    Toast.LENGTH_LONG).show();
            }
            
            // ã€ç¬¬13æ¬¡ä¿®æ”¹ã€‘åˆ·æ–°æˆ–åŠ è½½å®Œæˆï¼Œæ¢å¤åŠ è½½ä¸­çŠ¶æ€
            Log.d(TAG, "\nâŒ ç½‘ç»œè¯·æ±‚å¤±è´¥");
            Log.d(TAG, "ğŸ”„ æ¢å¤åŠ è½½çŠ¶æ€æ ‡å¿—");
            Log.d(TAG, "  - isRefreshing: " + isRefreshing + " â†’ false");
            Log.d(TAG, "  - isLoadingMore: " + isLoadingMore + " â†’ false");
            isRefreshing = false;
            isLoadingMore = false;
            isAutoLoadTriggered = false;  // é‡ç½®è‡ªåŠ¨åŠ è½½æ ‡å¿—ï¼Œå…è®¸ä¸‹æ¬¡è‡ªåŠ¨åŠ è½½
            newsAdapter.setLoading(false);  // æ¢å¤åŠ è½½ä¸­çŠ¶æ€
            Log.d(TAG, "==========================================\n");
        }
    });
    
    Log.d(TAG, "ç½‘ç»œè¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…å“åº”...");
}

/**
 * æ£€æµ‹å¹¶è§¦å‘è‡ªåŠ¨åŠ è½½
 */
private void checkAndTriggerAutoLoad() {
    // è·å–LayoutManager
    RecyclerView.LayoutManager layoutManager = recyclerView.getLayoutManager();
    if (layoutManager == null) return;
    
    int lastVisiblePosition = -1;
    
    // æ ¹æ®ä¸åŒçš„LayoutManagerç±»å‹è·å–æœ€åå¯è§é¡¹
    if (layoutManager instanceof LinearLayoutManager) {
        lastVisiblePosition = ((LinearLayoutManager) layoutManager).findLastVisibleItemPosition();
    } else if (layoutManager instanceof GridLayoutManager) {
        lastVisiblePosition = ((GridLayoutManager) layoutManager).findLastVisibleItemPosition();
    }
    
    int totalItemCount = newsAdapter.getItemCount();
    
    // åˆ¤æ–­æ˜¯å¦æ»šåŠ¨åˆ°æœ€åä¸€é¡¹ï¼Œä¸”è¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œä¸”æœªåœ¨åŠ è½½ä¸­ï¼Œä¸”æœªè§¦å‘è¿‡
    if (lastVisiblePosition >= totalItemCount - 1 && hasMoreData && !isLoadingMore && !isAutoLoadTriggered) {
        Log.d(TAG, "ğŸ“„ æ£€æµ‹åˆ°æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œå‡†å¤‡è‡ªåŠ¨åŠ è½½");
        Log.d(TAG, "  - lastVisiblePosition: " + lastVisiblePosition);
        Log.d(TAG, "  - totalItemCount: " + totalItemCount);
        Log.d(TAG, "  - hasMoreData: " + hasMoreData);
        
        // æ ‡è®°å·²è§¦å‘ï¼Œé˜²æ­¢é‡å¤è§¦å‘
        isAutoLoadTriggered = true;
        
        // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
        newsAdapter.setLoading(true);
        Log.d(TAG, "ğŸ”„ å·²æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œå»¶è¿Ÿ" + AUTO_LOAD_DELAY + "msååŠ è½½");
        
        // å–æ¶ˆä¹‹å‰çš„å»¶è¿Ÿä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
        if (autoLoadRunnable != null) {
            autoLoadHandler.removeCallbacks(autoLoadRunnable);
        }
        
        // åˆ›å»ºå»¶è¿Ÿä»»åŠ¡
        autoLoadRunnable = new Runnable() {
            @Override
            public void run() {
                Log.d(TAG, "â° å»¶è¿Ÿæ—¶é—´åˆ°ï¼Œå¼€å§‹åŠ è½½æ›´å¤šæ–°é—»");
                loadMoreNews();
            }
        };
        
        // å»¶è¿Ÿ2ç§’æ‰§è¡Œ
        autoLoadHandler.postDelayed(autoLoadRunnable, AUTO_LOAD_DELAY);
    }
}

/**
 * ã€ç¬¬13æ¬¡ä¿®æ”¹ã€‘åŠ è½½æ›´å¤šæ–°é—»
 * 
 * å…¬å…±æ–¹æ³•ï¼Œä¾›å¤–éƒ¨è°ƒç”¨ï¼ˆå¦‚ç‚¹å‡»"åŠ è½½æ›´å¤š"å¡ç‰‡ï¼‰
 * æ ¹æ®å½“å‰åˆ†ç±»åŠ è½½å¯¹åº”æ¿å—çš„æ–°é—»
 */
public void loadMoreNews() {
    Log.d(TAG, "\n========================================");
    Log.d(TAG, "ğŸ”˜ ç‚¹å‡»äº†ã€åŠ è½½æ›´å¤šã€‘æŒ‰é’®");
    Log.d(TAG, "========================================");
    Log.d(TAG, "ğŸ“Š å½“å‰çŠ¶æ€æ£€æŸ¥ï¼š");
    Log.d(TAG, "  - isLoadingMore: " + isLoadingMore);
    Log.d(TAG, "  - hasMoreData: " + hasMoreData);
    Log.d(TAG, "  - currentOffset: " + currentOffset);
    Log.d(TAG, "  - å½“å‰åˆ—è¡¨æ•°é‡: " + newsList.size());
    Log.d(TAG, "  - PAGE_SIZE: " + PAGE_SIZE);
    
    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½æˆ–å·²æ— æ›´å¤šæ•°æ®
    if (isLoadingMore || !hasMoreData) {
        Log.d(TAG, "âŒ æ— æ³•åŠ è½½æ›´å¤šï¼");
        if (isLoadingMore) {
            Log.d(TAG, "   åŸå› ï¼šæ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç­‰å¾…");
        }
        if (!hasMoreData) {
            Log.d(TAG, "   åŸå› ï¼šå·²æ— æ›´å¤šæ•°æ®");
            Toast.makeText(this, "å·²åŠ è½½å…¨éƒ¨æ•°æ®", Toast.LENGTH_SHORT).show();
        }
        Log.d(TAG, "========================================\n");
        return;
    }
    
    String categoryName = currentCategory == null ? "å…¨éƒ¨" : currentCategory;
    Log.d(TAG, "âœ… é€šè¿‡çŠ¶æ€æ£€æŸ¥ï¼Œå¯ä»¥åŠ è½½æ›´å¤š");
    Log.d(TAG, "ğŸ“¥ å¼€å§‹åŠ è½½æ›´å¤šã€" + categoryName + "ã€‘æ¿å—çš„æ–°é—»...");
    Log.d(TAG, "ğŸ“ å°†è¯·æ±‚ï¼šoffset=" + currentOffset + ", limit=" + PAGE_SIZE);
    
    // ã€ç¬¬13æ¬¡ä¿®æ”¹ã€‘æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
    newsAdapter.setLoading(true);
    Log.d(TAG, "ğŸ”„ å·²è®¾ç½®Adapterä¸ºåŠ è½½ä¸­çŠ¶æ€");
    
    loadNewsFromServer(true);  // trueè¡¨ç¤ºåŠ è½½æ›´å¤š
    Log.d(TAG, "========================================\n");
}

/**
 * ã€ç¬¬17æ¬¡ä¿®æ”¹ã€‘åˆå§‹åŒ–å¡ç‰‡æ›å…‰è¿½è¸ª
 */
private void initExposureTracker() {
    // ã€ç¬¬19æ¬¡ä¿®æ”¹ã€‘åˆ›å»ºå¹¶æ·»åŠ æµ‹è¯•é¢æ¿
    testPanel = new ExposureTestPanel(this);
    android.widget.FrameLayout testPanelContainer = findViewById(R.id.testPanelContainer);
    testPanelContainer.addView(testPanel);
    Log.d(TAG, "âœ… æµ‹è¯•é¢æ¿å·²åˆ›å»º");
    
    // åˆ›å»ºæ›å…‰è¿½è¸ªå™¨
    exposureTracker = new ExposureTracker(recyclerView, newsList);
    
    // è®¾ç½®æ›å…‰äº‹ä»¶ç›‘å¬å™¨
    exposureTracker.setExposureEventListener(new ExposureEventListener() {
        @Override
        public void onCardAppear(int position, NewsItem newsItem) {
            Log.i(TAG, String.format("ğŸ“ [æ›å…‰] å¡ç‰‡éœ²å‡º - ä½ç½®: %d, æ ‡é¢˜: %s", 
                position, newsItem.getTitle()));
            // ã€ç¬¬19æ¬¡ä¿®æ”¹ã€‘åŒæ­¥åˆ°æµ‹è¯•é¢æ¿
            testPanel.logAppear(position, newsItem.getTitle());
        }
        
        @Override
        public void onCardHalfVisible(int position, NewsItem newsItem, float visiblePercent) {
            Log.i(TAG, String.format("ğŸ“Š [æ›å…‰] å¡ç‰‡50%%å¯è§ - ä½ç½®: %d, æ ‡é¢˜: %s, å¯è§åº¦: %.2f%%", 
                position, newsItem.getTitle(), visiblePercent * 100));
            // ã€ç¬¬19æ¬¡ä¿®æ”¹ã€‘åŒæ­¥åˆ°æµ‹è¯•é¢æ¿
            testPanel.logHalfVisible(position, newsItem.getTitle(), visiblePercent);
        }
        
        @Override
        public void onCardFullyVisible(int position, NewsItem newsItem) {
            Log.i(TAG, String.format("âœ… [æ›å…‰] å¡ç‰‡å®Œæ•´éœ²å‡º - ä½ç½®: %d, æ ‡é¢˜: %s", 
                position, newsItem.getTitle()));
            // ã€ç¬¬19æ¬¡ä¿®æ”¹ã€‘åŒæ­¥åˆ°æµ‹è¯•é¢æ¿
            testPanel.logFullyVisible(position, newsItem.getTitle());
        }
        
        @Override
        public void onCardDisappear(int position, NewsItem newsItem) {
            Log.i(TAG, String.format("ğŸ‘‹ [æ›å…‰] å¡ç‰‡æ¶ˆå¤± - ä½ç½®: %d, æ ‡é¢˜: %s", 
                position, newsItem.getTitle()));
            // ã€ç¬¬19æ¬¡ä¿®æ”¹ã€‘åŒæ­¥åˆ°æµ‹è¯•é¢æ¿
            testPanel.logDisappear(position, newsItem.getTitle());
        }
    });
    
    // å¼€å§‹è¿½è¸ª
    exposureTracker.startTracking();
    
    Log.d(TAG, "âœ… å¡ç‰‡æ›å…‰è¿½è¸ªå·²å¯åŠ¨");
}
    
    /**
     * ã€ç¬¬17æ¬¡ä¿®æ”¹ã€‘Activityç”Ÿå‘½å‘¨æœŸ - onResume
     * æ¢å¤æ›å…‰è¿½è¸ª
     */
    @Override
    protected void onResume() {
        super.onResume();
        if (exposureTracker != null) {
            exposureTracker.startTracking();
            Log.d(TAG, "ğŸ”„ æ›å…‰è¿½è¸ªå·²æ¢å¤");
        }
    }
    
    /**
     * ã€ç¬¬17æ¬¡ä¿®æ”¹ã€‘Activityç”Ÿå‘½å‘¨æœŸ - onPause
     * æš‚åœæ›å…‰è¿½è¸ª
     */
    @Override
    protected void onPause() {
        super.onPause();
        if (exposureTracker != null) {
            exposureTracker.stopTracking();
            Log.d(TAG, "â¸ï¸ æ›å…‰è¿½è¸ªå·²æš‚åœ");
        }
    }
    
    /**
     * å…¶ä»–å¸¸ç”¨çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦é‡å†™ï¼‰ï¼š
     * 
     * @Override
     * protected void onStart() {
     *     super.onStart();
     *     // Activity å³å°†å¯¹ç”¨æˆ·å¯è§æ—¶è°ƒç”¨
     * }
     * 
     * @Override
     * protected void onStop() {
     *     super.onStop();
     *     // Activity å¯¹ç”¨æˆ·ä¸å¯è§æ—¶è°ƒç”¨
     * }
     * 
     * @Override
     * protected void onDestroy() {
     *     super.onDestroy();
     *     // Activity è¢«é”€æ¯å‰è°ƒç”¨ï¼Œç”¨äºé‡Šæ”¾èµ„æº
     * }
     */
}