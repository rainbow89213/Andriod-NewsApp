# 9. 多种卡片布局与删除功能

## 📋 功能概述

本次更新实现了以下功能：
1. **多种卡片布局** - 支持垂直和横向两种新闻卡片样式
2. **加载更多卡片化** - 将加载更多改为卡片形式，无边框，融入列表
3. **长按删除功能** - 长按新闻卡片可删除，带确认对话框

---

## 🎨 卡片布局类型

### 1. 垂直新闻卡片（VIEW_TYPE_NEWS_VERTICAL）

**布局文件**: `item_news_card.xml`

**结构**:
```
┌─────────────────────────────┐
│                             │
│     [新闻图片 - 200dp]      │
│                             │
├─────────────────────────────┤
│ 新闻标题（粗体，最多2行）    │
├─────────────────────────────┤
│ 新闻摘要（灰色，最多3行）    │
├─────────────────────────────┤
│ 🕐 2小时前    👁 1.2万阅读  │
└─────────────────────────────┘
```

**特点**:
- 图片在上方，占满宽度
- 标题粗体显示
- 适合图片为主的新闻

### 2. 横向新闻卡片（VIEW_TYPE_NEWS_HORIZONTAL）

**布局文件**: `item_news_card_horizontal.xml`

**结构**:
```
┌──────────────────────┬────────┐
│ 新闻标题（2行）       │        │
│                      │ [图片] │
│ 新闻摘要（2行）       │ 120dp  │
│                      │        │
│ 🕐 2小时前  👁 1.2万 │        │
└──────────────────────┴────────┘
```

**特点**:
- 图片在右侧，固定120dp
- 文字内容在左侧
- 适合文字为主的新闻

### 3. 加载更多卡片（VIEW_TYPE_LOAD_MORE）

**布局文件**: `item_load_more.xml`

**结构**:
```
┌─────────────────────────────┐
│                             │
│     点击加载更多（蓝色）     │  ← 有更多数据时
│                             │
└─────────────────────────────┘

┌─────────────────────────────┐
│                             │
│   已加载全部数据（灰色）     │  ← 无更多数据时
│                             │
└─────────────────────────────┘
```

**特点**:
- 无边框，无阴影
- 只包含文本
- 居中显示
- **始终显示在列表最后**（翻到最下方就能看到）
- 根据状态显示不同文本和颜色：
  - 有更多数据：**"点击加载更多"**（蓝色，可点击）
  - 加载中：**"加载中..."**（灰色，不可点击）
  - 无更多数据：**"已加载全部数据"**（灰色，不可点击）

---

## 🔌 后端API接口

### 分类加载API

后端需要支持按分类加载新闻，API接口定义如下：

```java
/**
 * 按分类获取新闻列表（支持分页）
 * 
 * 接口: GET /api/news
 * 参数:
 *   - category: 分类代码（可选）
 *   - offset: 偏移量（从第几条开始）
 *   - limit: 每页数量
 */
@GET("api/news")
Call<List<NewsItem>> getNewsListByCategory(
    @Query("category") String category,
    @Query("offset") Integer offset,
    @Query("limit") int limit
);
```

### API调用示例

#### 1. 加载全部新闻
```
GET /api/news?offset=0&limit=10
```

#### 2. 加载科技类新闻
```
GET /api/news?category=tech&offset=0&limit=10
```

#### 3. 加载教育类新闻第二页
```
GET /api/news?category=education&offset=10&limit=10
```

### 分类代码表

| 分类名称 | 分类代码 | 说明 |
|---------|---------|------|
| 全部 | null | 不传category参数 |
| 科技 | tech | 科技类新闻 |
| 经济 | economy | 经济类新闻 |
| 体育 | sports | 体育类新闻 |
| 健康 | health | 健康类新闻 |
| 娱乐 | entertainment | 娱乐类新闻 |
| 教育 | education | 教育类新闻 |
| 环保 | environment | 环保类新闻 |
| 美食 | food | 美食类新闻 |

---

## 🔄 布局切换规则

### 自动切换

```java
@Override
public int getItemViewType(int position) {
    // 如果是最后一个位置且显示加载更多
    if (position == newsList.size() && showLoadMore) {
        return VIEW_TYPE_LOAD_MORE;
    }
    // 偶数位置使用垂直布局，奇数位置使用横向布局
    return position % 2 == 0 ? VIEW_TYPE_NEWS_VERTICAL : VIEW_TYPE_NEWS_HORIZONTAL;
}
```

### 显示效果

```
第0条 - 垂直布局 📰
第1条 - 横向布局 📰
第2条 - 垂直布局 📰
第3条 - 横向布局 📰
...
加载更多卡片 ⬇️
```

---

## 🗑️ 长按删除功能

### 触发方式

1. **长按卡片** - 用户长按任意新闻卡片
2. **显示对话框** - 弹出删除确认对话框
3. **确认删除** - 用户点击"确定"按钮
4. **执行删除** - 从列表中移除该卡片

### 实现代码

```java
// 设置长按删除事件
itemView.setOnLongClickListener(v -> {
    if (deleteListener != null) {
        // 显示删除确认对话框
        new AlertDialog.Builder(v.getContext())
            .setTitle("删除新闻")
            .setMessage("确定要删除这条新闻吗？\n\n" + newsItem.getTitle())
            .setPositiveButton("确定", (dialog, which) -> {
                deleteListener.onItemDelete(position);
            })
            .setNegativeButton("取消", null)
            .show();
    }
    return true;
});
```

### 删除流程

```
用户长按卡片
  ↓
显示确认对话框
  ├─ 点击"确定"
  │   ↓
  │ 触发删除监听器
  │   ↓
  │ 从newsList中移除
  │   ↓
  │ 调用notifyItemRemoved
  │   ↓
  │ 显示Toast提示
  │
  └─ 点击"取消"
      ↓
    关闭对话框
```

---

## 💻 代码实现

### NewsAdapter改动

#### 1. 添加视图类型常量

```java
private static final int VIEW_TYPE_NEWS_VERTICAL = 0;    // 垂直新闻卡片
private static final int VIEW_TYPE_NEWS_HORIZONTAL = 1;  // 横向新闻卡片
private static final int VIEW_TYPE_LOAD_MORE = 2;        // 加载更多卡片
```

#### 2. 添加监听器接口

```java
// 加载更多点击监听接口
public interface OnLoadMoreClickListener {
    void onLoadMoreClick();
}

// 删除监听接口
public interface OnItemDeleteListener {
    void onItemDelete(int position);
}
```

#### 3. 创建多个ViewHolder

```java
// 新闻ViewHolder
public static class NewsViewHolder extends RecyclerView.ViewHolder {
    ImageView newsImage;
    TextView newsTitle;
    TextView newsSummary;
    TextView newsTime;
    TextView newsReadCount;
    
    public void bind(NewsItem newsItem, OnItemDeleteListener deleteListener, int position) {
        // 绑定数据
        // 设置点击事件
        // 设置长按删除事件
    }
}

// 加载更多ViewHolder
public static class LoadMoreViewHolder extends RecyclerView.ViewHolder {
    TextView loadMoreText;
    
    public void bind(OnLoadMoreClickListener listener) {
        itemView.setOnClickListener(v -> {
            if (listener != null) {
                listener.onLoadMoreClick();
            }
        });
    }
}
```

#### 4. 实现getItemViewType

```java
@Override
public int getItemViewType(int position) {
    if (position == newsList.size() && showLoadMore) {
        return VIEW_TYPE_LOAD_MORE;
    }
    return position % 2 == 0 ? VIEW_TYPE_NEWS_VERTICAL : VIEW_TYPE_NEWS_HORIZONTAL;
}
```

#### 5. 修改onCreateViewHolder

```java
@Override
public RecyclerView.ViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
    LayoutInflater inflater = LayoutInflater.from(parent.getContext());
    
    switch (viewType) {
        case VIEW_TYPE_NEWS_VERTICAL:
            View verticalView = inflater.inflate(R.layout.item_news_card, parent, false);
            return new NewsViewHolder(verticalView);
            
        case VIEW_TYPE_NEWS_HORIZONTAL:
            View horizontalView = inflater.inflate(R.layout.item_news_card_horizontal, parent, false);
            return new NewsViewHolder(horizontalView);
            
        case VIEW_TYPE_LOAD_MORE:
            View loadMoreView = inflater.inflate(R.layout.item_load_more, parent, false);
            return new LoadMoreViewHolder(loadMoreView);
            
        default:
            View defaultView = inflater.inflate(R.layout.item_news_card, parent, false);
            return new NewsViewHolder(defaultView);
    }
}
```

#### 6. 修改onBindViewHolder

```java
@Override
public void onBindViewHolder(@NonNull RecyclerView.ViewHolder holder, int position) {
    if (holder instanceof NewsViewHolder) {
        NewsItem newsItem = newsList.get(position);
        ((NewsViewHolder) holder).bind(newsItem, deleteListener, position);
    } else if (holder instanceof LoadMoreViewHolder) {
        ((LoadMoreViewHolder) holder).bind(loadMoreClickListener);
    }
}
```

### MainActivity改动

#### 1. 设置监听器

```java
// 设置加载更多监听器
newsAdapter.setOnLoadMoreClickListener(() -> {
    Log.d(TAG, "🔘 用户点击加载更多卡片");
    loadMoreNews();
});

// 设置删除监听器
newsAdapter.setOnItemDeleteListener(position -> {
    Log.d(TAG, "🗑️ 删除位置: " + position);
    if (position >= 0 && position < newsList.size()) {
        NewsItem deletedItem = newsList.get(position);
        newsList.remove(position);
        newsAdapter.notifyItemRemoved(position);
        Toast.makeText(this, "已删除：" + deletedItem.getTitle(), Toast.LENGTH_SHORT).show();
    }
});
```

#### 2. 控制加载更多卡片显示

```java
private void initLoadMoreText() {
    recyclerView.addOnScrollListener(new RecyclerView.OnScrollListener() {
        @Override
        public void onScrolled(@NonNull RecyclerView recyclerView, int dx, int dy) {
            // 检查是否滚动到底部
            if (!recyclerView.canScrollVertically(1)) {
                if (hasMoreData && !isLoadingMore) {
                    newsAdapter.setShowLoadMore(true);
                }
            } else {
                newsAdapter.setShowLoadMore(false);
            }
        }
    });
}
```

---

## 🎯 UI效果

### 列表展示

```
┌─────────────────────────────────────┐
│ [全部] [科技] [经济] ...            │ ← 分类栏
├───────────────────────────────┬─────┤
│ ┌───────────────────────────┐ │  ▓  │
│ │   [新闻图片]              │ │     │ ← 垂直卡片
│ │ 标题标题标题              │ │  ▓  │
│ │ 摘要摘要摘要              │ │     │
│ └───────────────────────────┘ │     │
│ ┌────────────────┬──────────┐ │  ▓  │
│ │ 标题标题       │ [图片]   │ │     │ ← 横向卡片
│ │ 摘要摘要       │          │ │  ▓  │
│ └────────────────┴──────────┘ │     │
│ ┌───────────────────────────┐ │  ▓  │
│ │   [新闻图片]              │ │     │ ← 垂直卡片
│ │ 标题标题标题              │ │  ▓  │
│ └───────────────────────────┘ │     │
│                               │  ▓  │
│     点击加载更多（蓝色）       │     │ ← 加载更多卡片
│                               │     │
└───────────────────────────────┴─────┘
```

### 删除对话框

```
┌─────────────────────────────┐
│      删除新闻               │
├─────────────────────────────┤
│ 确定要删除这条新闻吗？       │
│                             │
│ 人工智能技术取得重大突破     │
├─────────────────────────────┤
│         [取消]  [确定]      │
└─────────────────────────────┘
```

---

## 🧪 测试验证

### 测试用例1：多种布局显示
**步骤**:
1. 打开应用
2. 观察新闻列表

**预期结果**:
- ✅ 第0、2、4...条使用垂直布局
- ✅ 第1、3、5...条使用横向布局
- ✅ 布局交替显示

### 测试用例2：加载更多卡片显示
**步骤**:
1. 打开应用，加载第一页数据
2. 滚动到列表底部

**预期结果**:
- ✅ 始终显示加载更多卡片在列表最后
- ✅ 显示"点击加载更多"文本
- ✅ 无边框，无阴影
- ✅ 文本为蓝色
- ✅ 不需要滚动到底部才出现，翻到最后就能看到

### 测试用例3：点击加载更多
**步骤**:
1. 滚动到底部
2. 点击"加载更多"卡片

**预期结果**:
- ✅ 加载下一页数据
- ✅ 数据追加到列表
- ✅ 卡片仍然显示在列表最后

### 测试用例3.1：分类板块加载更多
**步骤**:
1. 点击"科技"分类
2. 滚动到底部
3. 点击"加载更多"卡片

**预期结果**:
- ✅ 只加载科技类新闻
- ✅ 数据追加到列表
- ✅ 不会混入其他分类的新闻

### 测试用例3.2：加载中状态显示
**步骤**:
1. 点击"加载更多"卡片
2. 观察卡片状态变化

**预期结果**:
- ✅ 立即显示"加载中..."
- ✅ 文本变为灰色
- ✅ 不可点击
- ✅ 加载完成后恢复为"点击加载更多"或"已加载全部数据"

### 测试用例4：长按删除
**步骤**:
1. 长按任意新闻卡片
2. 观察对话框

**预期结果**:
- ✅ 显示删除确认对话框
- ✅ 对话框显示新闻标题
- ✅ 有"确定"和"取消"按钮

### 测试用例5：确认删除
**步骤**:
1. 长按卡片
2. 点击"确定"按钮

**预期结果**:
- ✅ 卡片从列表中移除
- ✅ 显示"已删除：xxx"提示
- ✅ 列表平滑动画

### 测试用例6：取消删除
**步骤**:
1. 长按卡片
2. 点击"取消"按钮

**预期结果**:
- ✅ 对话框关闭
- ✅ 卡片保留在列表中
- ✅ 无任何变化

---

## 📁 文件清单

### 新增文件

1. **item_news_card_horizontal.xml** - 横向新闻卡片布局
2. **item_load_more.xml** - 加载更多卡片布局
3. **9.多种卡片布局与删除功能.md** - 本文档

### 修改文件

1. **NewsAdapter.java**
   - 添加多种ViewHolder
   - 实现getItemViewType
   - 添加删除监听器
   - 修改onCreateViewHolder和onBindViewHolder

2. **MainActivity.java**
   - 设置加载更多监听器
   - 设置删除监听器
   - 修改加载更多显示逻辑

3. **activity_main.xml**
   - 移除独立的loadMoreText组件

---

## 🎨 样式对比

### 垂直布局 vs 横向布局

| 特性 | 垂直布局 | 横向布局 |
|------|---------|---------|
| 图片位置 | 上方 | 右侧 |
| 图片大小 | match_parent × 200dp | 120dp × 120dp |
| 标题行数 | 2行 | 2行 |
| 摘要行数 | 3行 | 2行 |
| 适用场景 | 图片为主 | 文字为主 |

### 加载更多：按钮 vs 卡片

| 特性 | 旧版（按钮） | 新版（卡片） |
|------|-------------|-------------|
| 位置 | 固定底部 | 列表内部 |
| 显示 | 始终可见 | 滚动到底部显示 |
| 样式 | 有背景色 | 无边框 |
| 融入度 | 独立组件 | 融入列表 |

---

## 🔧 技术要点

### 1. 多ViewHolder模式

```java
// 父类ViewHolder
RecyclerView.ViewHolder

// 子类ViewHolder
NewsViewHolder extends RecyclerView.ViewHolder
LoadMoreViewHolder extends RecyclerView.ViewHolder
```

### 2. ViewType判断

```java
// 根据position和状态返回不同的ViewType
public int getItemViewType(int position) {
    if (position == newsList.size() && showLoadMore) {
        return VIEW_TYPE_LOAD_MORE;
    }
    return position % 2 == 0 ? VIEW_TYPE_NEWS_VERTICAL : VIEW_TYPE_NEWS_HORIZONTAL;
}
```

### 3. 长按事件处理

```java
itemView.setOnLongClickListener(v -> {
    // 显示对话框
    new AlertDialog.Builder(v.getContext())
        .setTitle("删除新闻")
        .setMessage("确定要删除这条新闻吗？")
        .setPositiveButton("确定", (dialog, which) -> {
            // 执行删除
        })
        .setNegativeButton("取消", null)
        .show();
    return true;  // 返回true表示已处理
});
```

### 4. 动态显示/隐藏

```java
// 控制加载更多卡片的显示
public void setShowLoadMore(boolean show) {
    this.showLoadMore = show;
    notifyDataSetChanged();  // 刷新列表
}
```

---

## ⚠️ 注意事项

### 1. ViewType一致性

确保`getItemViewType`和`onCreateViewHolder`中的ViewType值一致。

### 2. 位置计算

加载更多卡片的position是`newsList.size()`，不是`newsList.size() - 1`。

### 3. 删除动画

使用`notifyItemRemoved(position)`而不是`notifyDataSetChanged()`，以获得平滑的删除动画。

### 4. 长按返回值

`setOnLongClickListener`必须返回`true`，否则会同时触发点击事件。

---

## 🚀 未来优化

1. **更多布局样式** - 添加大图、无图等更多样式
2. **自定义布局规则** - 支持用户自定义布局切换规则
3. **撤销删除** - 添加撤销删除功能（Snackbar）
4. **批量删除** - 支持多选批量删除
5. **拖拽排序** - 支持长按拖拽调整顺序

---

**文档版本**: v1.0  
**最后更新**: 2025-11-23  
**相关文档**: 
- [2.新闻卡片功能说明.md](./2.新闻卡片功能说明.md)
- [8.分类与加载更多与刷新逻辑.md](./8.分类与加载更多与刷新逻辑.md)
